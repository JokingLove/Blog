<!DOCTYPE html>
<html lang="en">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  
  
    <meta name="keywords" content="blog,joking,博客，programmer,jokinglove,JOKING,JOKINGLOVE,java,JAVASCRIPT">
  
  
    <meta name="description" content="会当凌绝顶，一览众山小">
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>
    Spring Boot 整合 ElasticSearch 入门 |
    
    JOKING</title>
  
    <link rel="shortcut icon" href="/favicon.ico">
  
  <link rel="stylesheet" href="/blog/css/style.css">
  
    <link rel="stylesheet" href="/blog/fancybox/jquery.fancybox.min.css">
  
  <script src="/blog/js/pace.min.js"></script>
</head>
</html>
<body>
<main class="content">
  <section class="outer">
  <article id="post-others/microservice/20190524-spring-boot-elasticsearch" class="article article-type-post" itemscope itemprop="blogPost" data-scroll-reveal>

    <div class="article-inner">
        
            <header class="article-header">
                
  
    <h1 class="article-title" itemprop="name">
      Spring Boot 整合 ElasticSearch 入门
    </h1>
  
  




            </header>
            

                
                    <div class="article-meta">
                        <a href="/blog/2019/05/13/others/microservice/20190524-spring-boot-elasticsearch/" class="article-date">
  <time datetime="2019-05-12T16:00:00.000Z" itemprop="datePublished">2019-05-13</time>
</a>
                            
  <div class="article-category">
    <a class="article-category-link" href="/blog/group/categories/IT/">IT</a>
  </div>

                    </div>
                    

                        
                            
    <div class="tocbot"></div>





                                

                                    <div class="article-entry" itemprop="articleBody">
                                        


                                            

                                                
                                                                    <h3 id="spring-boot-整合-elasticsearch-入门">Spring Boot 整合 ElasticSearch 入门</h3>
<p>​	利用 spring data elasticsearch 模块来对 elasticsearch 进行基础的增删改查，elasticsearch 利用 docker 的方式启动运行。</p>
<h4 id="启动-elasticsearch">启动 elasticsearch</h4>
<h6 id="下载-elasticsearch-的-docker-镜像：">下载 elasticsearch 的 docker 镜像：</h6>
<figure class="highlight zsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull docker.elastic.co/elasticsearch/elasticsearch:6.7.2</span><br></pre></td></tr></table></figure>
<h6 id="以开发模式运行-elasticsearch-的-docker-容器：">以开发模式运行 elasticsearch 的 docker 容器：</h6>
<figure class="highlight zsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 9200:9200 -p 9300:9300 -e <span class="string">"discovery.type=single-node"</span> docker.elastic.co/elasticsearch/elasticsearch:6.7.2</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h6 id="浏览器访问-http-localhost-9200-出现如下信息就说明启动成功：">浏览器访问 <a href="http://localhost:9200/" target="_blank" rel="noopener">http://localhost:9200/</a> 出现如下信息就说明启动成功：</h6>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  name: "-jrZGj7",</span><br><span class="line">  cluster_name: "docker-cluster",</span><br><span class="line">  cluster_uuid: "-3-MZwe_QImewxAtCSweKQ",</span><br><span class="line">  version: &#123;</span><br><span class="line">    number: "6.7.2",</span><br><span class="line">    build_flavor: "default",</span><br><span class="line">    build_type: "docker",</span><br><span class="line">    build_hash: "56c6e48",</span><br><span class="line">    build_date: "2019-04-29T09:05:50.290371Z",</span><br><span class="line">    build_snapshot: false,</span><br><span class="line">    lucene_version: "7.7.0",</span><br><span class="line">    minimum_wire_compatibility_version: "5.6.0",</span><br><span class="line">    minimum_index_compatibility_version: "5.0.0"</span><br><span class="line">  &#125;,</span><br><span class="line">	tagline: "You Know, for Search"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="编写测试程序来连接-elasticsearch">编写测试程序来连接 elasticsearch</h3>
<h6 id="创建名为-spring-boot-elasticsearch-的-spring-boot-项目-在-pom-xml-中添加下面的依赖：">创建名为 spring-boot-elasticsearch 的 Spring Boot 项目，在 pom.xml 中添加下面的依赖：</h6>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- elasticsearch jar --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-elasticsearch<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h6 id="在-application-xml-文件中加入下面配置：">在 application.xml 文件中加入下面配置：</h6>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">server.port= 8080</span><br><span class="line">spring.application.name = spring-boot-elasticsearch</span><br><span class="line"># 注意，这个位置一定要配置，不然会报  not avaliable node 的错误的，具体的 cluster-name 是从浏览器中访问 http://localhost:9200/ 接口中获取的</span><br><span class="line">spring.data.elasticsearch.cluster-name=docker-cluster</span><br><span class="line">spring.data.elasticsearch.cluster-nodes=127.0.0.1:9300</span><br></pre></td></tr></table></figure>
<h6 id="创建-goodsiznfo-java-类">创建 GoodsIznfo.java 类</h6>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ikang.springbootelasticsearch.document;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.elasticsearch.annotations.Document;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Document</span>(indexName = <span class="string">"testgoods"</span>, type = <span class="string">"goods"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GoodsInfo</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String description;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GoodsInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GoodsInfo</span><span class="params">(Long id, String name, String description)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.description = description;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Long <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(Long id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getDescription</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> description;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDescription</span><span class="params">(String description)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.description = description;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="创建-goodsinforepository-java-接口继承-elasticsearchrepository-接口">创建 GoodsInfoRepository.java 接口继承 ElasticsearchRepository  接口</h6>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ikang.springbootelasticsearch.repository;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.ikang.springbootelasticsearch.document.GoodsInfo;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.elasticsearch.repository.ElasticsearchRepository;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">GoodsRepository</span> <span class="keyword">extends</span> <span class="title">ElasticsearchRepository</span>&lt;<span class="title">GoodsInfo</span>, <span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="创建-goodsinfocontroller-java">创建 GoodsInfoController.java</h6>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ikang.springbootelasticsearch.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.ikang.springbootelasticsearch.document.GoodsInfo;</span><br><span class="line"><span class="keyword">import</span> com.ikang.springbootelasticsearch.repository.GoodsRepository;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.index.query.QueryBuilders;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.fetch.subphase.highlight.HighlightBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.domain.Page;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.domain.PageRequest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.domain.Pageable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.elasticsearch.core.query.NativeSearchQuery;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.elasticsearch.core.query.NativeSearchQueryBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Optional;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"goods"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GoodsController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> GoodsRepository goodsRepository;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GoodsController</span><span class="params">(GoodsRepository goodsRepository)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.goodsRepository = goodsRepository;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"save"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">save</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        GoodsInfo goodsInfo = <span class="keyword">new</span> GoodsInfo(System.currentTimeMillis(),</span><br><span class="line">                <span class="string">"商品"</span> + System.currentTimeMillis(), <span class="string">"这是一个测试商品！"</span>);</span><br><span class="line"></span><br><span class="line">        goodsRepository.save(goodsInfo);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"success"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"delete"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">delete</span><span class="params">(Long id)</span> </span>&#123;</span><br><span class="line">        goodsRepository.deleteById(id);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"success"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"update"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">update</span><span class="params">(Long id, String name, String description)</span> </span>&#123;</span><br><span class="line">        GoodsInfo goodsInfo = <span class="keyword">new</span> GoodsInfo(id, name, description);</span><br><span class="line">        goodsRepository.save(goodsInfo);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"success"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"getOne"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> GoodsInfo <span class="title">getOne</span><span class="params">(Long id)</span> </span>&#123;</span><br><span class="line">        Optional&lt;GoodsInfo&gt; optional = goodsRepository.findById(id);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> optional.isPresent() ? optional.get() : <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"list"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;GoodsInfo&gt; <span class="title">list</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Iterable&lt;GoodsInfo&gt; all = goodsRepository.findAll();</span><br><span class="line">        List&lt;GoodsInfo&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        all.forEach(list::add);</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 每页查询数量</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Integer DEFAULT_PAGE_SIZE = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"getList"</span>)</span><br><span class="line">        <span class="function"><span class="keyword">public</span> Page&lt;GoodsInfo&gt; <span class="title">getList</span><span class="params">(Integer pageNum, String query)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        Pageable page = PageRequest.of(pageNum, DEFAULT_PAGE_SIZE);</span><br><span class="line"></span><br><span class="line">        NativeSearchQuery nativeSearchQuery = <span class="keyword">new</span> NativeSearchQueryBuilder()</span><br><span class="line">                .withPageable(page)</span><br><span class="line">                .withQuery(QueryBuilders.matchAllQuery())</span><br><span class="line">                .withFilter(QueryBuilders.matchQuery(<span class="string">"name"</span>, query))</span><br><span class="line">                .withFilter(QueryBuilders.matchQuery(<span class="string">"description"</span>, query))</span><br><span class="line">                .withHighlightFields(<span class="keyword">new</span> HighlightBuilder.Field(<span class="string">"name"</span>).preTags(<span class="string">"&lt;font color='red'&gt;"</span>).postTags(<span class="string">"&lt;/font&gt;"</span>),</span><br><span class="line">                        <span class="keyword">new</span> HighlightBuilder.Field(<span class="string">"description"</span>).preTags(<span class="string">"&lt;font color='red'&gt;"</span>).postTags(<span class="string">"&lt;/font&gt;"</span>))</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        Page&lt;GoodsInfo&gt; goodsInfos = goodsRepository.search(nativeSearchQuery);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> goodsInfos;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="测试结果：">测试结果：</h4>
<ul>
<li>在浏览器中访问 <a href="http://localhost:8080/goods/save%EF%BC%8C" target="_blank" rel="noopener">http://localhost:8080/goods/save，</a> <a href="http://localhost:8080/goods/update%EF%BC%8Chttp://localhost:8080/goods/list" target="_blank" rel="noopener">http://localhost:8080/goods/update，http://localhost:8080/goods/list</a> 将会看到所有数据已经插入，并且可以查询出来了：</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">content: [</span><br><span class="line">&#123;</span><br><span class="line">id: 1558662806732,</span><br><span class="line">name: "商品1558662806732",</span><br><span class="line">description: "这是一个测试商品！"</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">id: 1558662808245,</span><br><span class="line">name: "商品1558662808245",</span><br><span class="line">description: "这是一个测试商品！"</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">id: 1558662893476,</span><br><span class="line">name: "商品1558662893476",</span><br><span class="line">description: "这是一个测试商品！"</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">id: 1558662901290,</span><br><span class="line">name: "商品1558662901290",</span><br><span class="line">description: "这是一个测试商品！"</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">id: 1558662627656,</span><br><span class="line">name: "商品1558662627656",</span><br><span class="line">description: "这是一个测试商品！"</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">id: 1558662804196,</span><br><span class="line">name: "商品1558662804196",</span><br><span class="line">description: "这是一个测试商品！"</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">id: 1558662807792,</span><br><span class="line">name: "商品1558662807792",</span><br><span class="line">description: "这是一个测试商品！"</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">id: 1558662808433,</span><br><span class="line">name: "商品1558662808433",</span><br><span class="line">description: "这是一个测试商品！"</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">id: 1558662896876,</span><br><span class="line">name: "商品1558662896876",</span><br><span class="line">description: "这是一个测试商品！"</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">id: 1558662900326,</span><br><span class="line">name: "商品1558662900326",</span><br><span class="line">description: "这是一个测试商品！"</span><br><span class="line">&#125;</span><br><span class="line">],</span><br><span class="line">pageable: &#123;</span><br><span class="line">sort: &#123;</span><br><span class="line">unsorted: true,</span><br><span class="line">sorted: false,</span><br><span class="line">empty: true</span><br><span class="line">&#125;,</span><br><span class="line">offset: 10,</span><br><span class="line">pageSize: 10,</span><br><span class="line">pageNumber: 1,</span><br><span class="line">paged: true,</span><br><span class="line">unpaged: false</span><br><span class="line">&#125;,</span><br><span class="line">facets: [ ],</span><br><span class="line">aggregations: null,</span><br><span class="line">scrollId: null,</span><br><span class="line">maxScore: 1,</span><br><span class="line">totalElements: 26,</span><br><span class="line">totalPages: 3,</span><br><span class="line">size: 10,</span><br><span class="line">number: 1,</span><br><span class="line">sort: &#123;</span><br><span class="line">unsorted: true,</span><br><span class="line">sorted: false,</span><br><span class="line">empty: true</span><br><span class="line">&#125;,</span><br><span class="line">last: false,</span><br><span class="line">numberOfElements: 10,</span><br><span class="line">first: false,</span><br><span class="line">empty: false</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="遇到的问题：">遇到的问题：</h4>
<ul>
<li>1、启动报下面错误：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">2019-05-24 11:26:57.753  WARN 9683 --- [           main] o.e.c.t.TransportClientNodesService      : node &#123;<span class="comment">#transport#-1&#125;&#123;qZfhmDjMRiKldY_XKULvNg&#125;&#123;127.0.0.1&#125;&#123;127.0.0.1:9300&#125; not part of the cluster Cluster [elasticsearch], ignoring...</span></span><br><span class="line">2019-05-24 11:26:58.201 ERROR 9683 --- [           main] .d.e.r.s.AbstractElasticsearchRepository : failed to load elasticsearch nodes : org.elasticsearch.client.transport.NoNodeAvailableException: None of the configured nodes are available: [&#123;<span class="comment">#transport#-1&#125;&#123;qZfhmDjMRiKldY_XKULvNg&#125;&#123;127.0.0.1&#125;&#123;127.0.0.1:9300&#125;]</span></span><br><span class="line">2019-05-24 11:26:58.350  INFO 9683 --- [           main] o.s.s.concurrent.ThreadPoolTaskExecutor  : Initializing ExecutorService <span class="string">'applicationTaskExecutor'</span></span><br><span class="line">2019-05-24 11:26:58.536  INFO 9683 --- [           main] o.s.b.a.e.web.EndpointLinksResolver      : Exposing 2 endpoint(s) beneath base path <span class="string">'/actuator'</span></span><br><span class="line">2019-05-24 11:26:58.588  INFO 9683 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat started on port(s): 8080 (http) with context path <span class="string">''</span></span><br><span class="line">2019-05-24 11:26:58.590  INFO 9683 --- [           main] c.i.s.SpringBootElasticsearchApplication : Started SpringBootElasticsearchApplication <span class="keyword">in</span> 3.707 seconds (JVM running <span class="keyword">for</span> 4.354)</span><br><span class="line">2019-05-24 11:26:58.648  INFO 9683 --- [)-172.16.98.240] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring DispatcherServlet <span class="string">'dispatcherServlet'</span></span><br><span class="line">2019-05-24 11:26:58.648  INFO 9683 --- [)-172.16.98.240] o.s.web.servlet.DispatcherServlet        : Initializing Servlet <span class="string">'dispatcherServlet'</span></span><br><span class="line">2019-05-24 11:26:58.652  WARN 9683 --- [)-172.16.98.240] o.s.b.a.e.ElasticsearchHealthIndicator   : Elasticsearch health check failed</span><br><span class="line"></span><br><span class="line">org.elasticsearch.client.transport.NoNodeAvailableException: None of the configured nodes are available: [&#123;<span class="comment">#transport#-1&#125;&#123;qZfhmDjMRiKldY_XKULvNg&#125;&#123;127.0.0.1&#125;&#123;127.0.0.1:9300&#125;]</span></span><br><span class="line">	at org.elasticsearch.client.transport.TransportClientNodesService.ensureNodesAreAvailable(TransportClientNodesService.java:349) ~[elasticsearch-6.4.3.jar:6.4.3]</span><br><span class="line">	at</span><br></pre></td></tr></table></figure>
<blockquote>
<p>问题分析：</p>
<p>这是因为 springboot 中默认的 cluster-name 为 <code>elasticsearch</code>，我们用 docker 启动的 <code>elasticsearch</code> 默认的名称是 <code>docker-cluster</code>, 所以在  application.xml 中加入以下配置就可以解决问题：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; spring.data.elasticsearch.cluster-name=docker-cluster</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<ul>
<li>2、在查询过程中会报一个无法反序列化的问题，这个问题的解决方法是在 GoodsInfo.java 中加入一个默认的无参构造方法，具体为什么，应该和 jackson 的序列化有关。</li>
</ul>

                                                                        
                                    </div>
                                    <footer class="article-footer">
                                        <a data-url="https://jokinglove.com/blog/2019/05/13/others/microservice/20190524-spring-boot-elasticsearch/" data-id="ckbhoivur0036n5sbbt2f5zrm" class="article-share-link">
                                            分享
                                        </a>
                                        
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/group/tags/ES/">ES</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/group/tags/IT/">IT</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/group/tags/springboot/">springboot</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/group/tags/大数据/">大数据</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/group/tags/搜索/">搜索</a></li></ul>

                                    </footer>

    </div>

    
        
  <nav class="article-nav">
    
      <a href="/blog/2019/05/14/others/kafka/20190524-spring-kafka/" class="article-nav-link">
        <strong class="article-nav-caption">前一篇</strong>
        <div class="article-nav-title">
          
            Kafka (a distributed streaming platform)
          
        </div>
      </a>
    
    
      <a href="/blog/2019/05/12/others/microservice/20190512-cat/" class="article-nav-link">
        <strong class="article-nav-caption">后一篇</strong>
        <div class="article-nav-title">美团系统监控工具 Cat 入门</div>
      </a>
    
  </nav>


            

                
                    
                        
  <div class="gitalk" id="gitalk-container"></div>
  <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
  <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
  <script src="https://cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.min.js"></script>
  <script type="text/javascript">
    var gitalk = new Gitalk({
      clientID: 'Iv1.4968518393d3b9f1',
      clientSecret: 'ad03ce244f26e942defd4a4918834ac65333a981',
      repo: 'site_comments',
      owner: 'JokingLove',
      admin: ['JokingLove'],
      // id: location.pathname,      // Ensure uniqueness and length less than 50
      id: md5(location.pathname),
      distractionFreeMode: false,  // Facebook-like distraction free mode
      pagerDirection: 'last'
    })

  gitalk.render('gitalk-container')
  </script>

                            

</article>
</section>
  <footer class="footer">
  <div class="outer">
    <div class="float-right">
      <ul class="list-inline">
  
    <li><i class="fe fe-smile-alt"></i> <span id="busuanzi_value_site_uv"></span></li>
  
    <li><i class="fe fe-bookmark"></i> <span id="busuanzi_value_page_pv"></span></li>
  
</ul>
    </div>
    <ul class="list-inline">
      <li>&copy; 2020 JOKING</li>
      <li>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a></li>
      <li>Theme  <a href="https://github.com/zhwangart/hexo-theme-ocean">Ocean</a></li>
    </ul>
  </div>
</footer>

</main>
<aside class="sidebar">
  <button class="navbar-toggle"></button>
<nav class="navbar">
  
    <div class="logo">
      <a href="/blog/"><img src="https://avatars2.githubusercontent.com/u/18134074?s=460&v=4" alt="JOKING"></a>
    </div>
  
  <ul class="nav nav-main">
    
      <li class="nav-item">
        <a class="nav-item-link" href="/blog/">主页</a>
      </li>
    
      <li class="nav-item">
        <a class="nav-item-link" href="/blog/archives">归档</a>
      </li>
    
      <li class="nav-item">
        <a class="nav-item-link" href="/blog/gallery">相册</a>
      </li>
    
      <li class="nav-item">
        <a class="nav-item-link" href="/blog/about">关于</a>
      </li>
    
      <li class="nav-item">
        <a class="nav-item-link" href="/blog/friends">友链</a>
      </li>
    
    <li class="nav-item">
      <a class="nav-item-link nav-item-search" title="搜索">
        <i class="fe fe-search"></i>
        搜索
      </a>
    </li>
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      <div class="totop" id="totop">
  <i class="fe fe-rocket"></i>
</div>
    </li>
    <li class="nav-item">
      
        <a class="nav-item-link" target="_blank" href="/blog/atom.xml" title="RSS Feed">
          <i class="fe fe-feed"></i>
        </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
</aside>
<script src="/blog/js/jquery-2.0.3.min.js"></script>
<script src="/blog/js/jquery.justifiedGallery.min.js"></script>
<script src="/blog/js/lazyload.min.js"></script>
<script src="/blog/js/busuanzi-2.3.pure.min.js"></script>

  <script src="/blog/fancybox/jquery.fancybox.min.js"></script>



  <script src="/blog/js/tocbot.min.js"></script>
  <script>
    // Tocbot_v4.7.0  http://tscanlin.github.io/tocbot/
    tocbot.init({
      tocSelector: '.tocbot',
      contentSelector: '.article-entry',
      headingSelector: 'h1, h2, h3, h4, h5, h6',
      hasInnerContainers: true,
      scrollSmooth: true,
      positionFixedSelector: '.tocbot',
      positionFixedClass: 'is-position-fixed',
      fixedSidebarOffset: 'auto',
    });
  </script>


<script src="/blog/js/ocean.js"></script>


</body>
</html>